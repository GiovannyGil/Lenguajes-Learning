SET PROCEDURE TO controlador ADDITIVE
SET PROCEDURE TO grupos ADDITIVE
SET PROCEDURE TO Dependencias ADDITIVE
SET PROCEDURE TO TareaDTO ADDITIVE
SET PROCEDURE TO Tareas ADDITIVE

Local oForm 
oForm = CREATEOBJECT("FormularioCRUD")
oForm.show(1)

DEFINE CLASS FormularioCRUD As Form

	Caption = "Actividad CRUD"
	width = 476
	Height = 450

	PROCEDURE Init()
		*!*	 añadir el controlador
		This.AddObject("Controlador", "Controlador")
        This.Controlador.Init()
        This.Formulario()
        This.GridTareas()
        This.LlenarCombos()
		This.BindeoEventos()
	ENDPROC

	PROCEDURE Formulario as Form

		* Titulo
		This.AddObject("Titulo", "Label")
		WITH thisform.Titulo
			.visible = .T.
			.Caption = "FORMULARIO"
			.left = 130
			.top = 20
			.fontsize = 24
			.width = 300
			.Height = 50
		ENDWITH

		*-------------------------------------------------------------------------------------

		* Crear el label e input Nombre
        THIS.AddObject("lblNombre", "Label")
        WITH This.lblNombre
            .Visible = .T.
            .Top = 100
            .Left = 30
            .Caption = "Nombre:"
        ENDWITH

        THIS.AddObject("txtNombre", "Textbox")
        WITH This.txtNombre
            .Visible = .T.
            .Top = 117
            .Left = 30
            .Width = 100
        ENDWITH

		* ---------------------------------------

    	* Crear el label e input Grupo
        THIS.AddObject("lblGrupo", "Label")
        WITH This.lblGrupo
            .Visible = .T.
            .Top = 100
            .Left = 145
            .Caption = "Grupo:"
        ENDWITH

        THIS.AddObject("cbxGrupo", "ComboBox")
        WITH This.cbxGrupo
            .Visible = .T.
            .Top = 117
            .Left = 145
            .Width = 100
        ENDWITH

		* ---------------------------------------

		* Crear el label e input Dependencia
        THIS.AddObject("lblDependencia", "Label")
        WITH This.lblDependencia
            .Visible = .T.
            .Top = 100
            .Left = 260
            .Caption = "Dependencia:"
        ENDWITH

        THIS.AddObject("cbxDependencia", "ComboBox")
        WITH This.cbxDependencia
            .Visible = .T.
            .Top = 117
            .Left = 260
            .Width = 100
        ENDWITH

		* ---------------------------------------

		* Crear el label e input Descripcion
        THIS.AddObject("lblDescripcion", "Label")
        WITH This.lblDescripcion
            .Visible = .T.
            .Top = 150
            .Left = 30
            .Caption = "Descripcion:"
        ENDWITH

        THIS.AddObject("txtDescripcion", "Textbox")
        WITH This.txtDescripcion
            .Visible = .T.
            .Top = 167
            .Left = 30
            .Width = 330
            .Height = 65
        ENDWITH

		* ---------------------------------------

    	* Crear el label e input IDTarea para la solicitud de leer la tarea
        THIS.AddObject("lblID", "Label")
        WITH This.lblID
            .Visible = .T.
            .Top = 248
            .Left = 30
            .Caption = "ID:"
            .Width = 50
        ENDWITH

        THIS.AddObject("txtID", "Textbox")
        WITH This.txtID
            .Visible = .T.
            .Top = 245
            .Left = 50
            .Width = 40
        ENDWITH

    	*-------------------------------------------------------------------------------------


    	* Botones


		* ---------------------------------------

        * Leer
        THIS.AddObject("btnLeer", "CommandButton")
        WITH This.btnLeer
            .Caption = "Leer"
            .Top = 240
            .Left = 390
            .Width = 60
            .Height = 30
            .Visible = .T.
        ENDWITH

		* ---------------------------------------
        * Guardar
        THIS.AddObject("btnGuardar", "CommandButton")
        WITH This.btnGuardar
            .Caption = "Guardar"
            .Top = 120
            .Left = 390
            .Width = 60
            .Height = 30
            .Visible = .T.
        ENDWITH

		* ---------------------------------------
        * Actualizar
        THIS.AddObject("btnActualizar", "CommandButton")
        WITH This.btnActualizar
            .Caption = "Actualizar"
            .Top = 155
            .Left = 390
            .Width = 60
            .Height = 30
            .Visible = .T.            
        ENDWITH
 
		* ---------------------------------------

        * Eliminar
        THIS.AddObject("btnEliminar", "CommandButton")
        WITH This.btnEliminar
            .Caption = "Eliminar"
            .Top = 190
            .Left = 390
            .Width = 60
            .Height = 30
            .Visible = .T.
        ENDWITH

		* ---------------------------------------
		
    	* Linea divisora
    	This.AddObject("LineaDivisora", "Shape")
    	WITH thisform.LineaDivisora
    		.top = 235
    		.visible = .T.
    		.BackStyle = 1
    		.BorderWidth = 1
    		.Width = 419
    		.Height = 1
    		.Visible = .T.
    		.Left = 30
    	ENDWITH

	ENDPROC
	
	*-------------------------------------------------------------------------------------
	   
    * Actualizar el grid con las tareas
    PROCEDURE GridTareas
        THIS.AddObject("grdTareas", "Grid")
        WITH This.grdTareas
            .Left = 30
            .Top = 275
            .Width = 418
            .Height = 164
            .Visible = .T.
            .ColumnCount = 5
            
            * Llamar a la función ListarTareas para obtener los datos
            Thisform.ListarTareas()

                        
            * Enlazar el cursor al grid
            .RecordSource = "curTareas" && 
            .RecordSourceType = 2  && 2 indica que RecordSource es un alias de tabla
            
            * Mover el cursor al primer registro
            GO TOP IN curTareas
            
            * Refrescar el grid para asegurarse de que todos los registros se muestren
            .Refresh()
            
            * Configurar las columnas del grid
            .Column1.Header1.Caption = "ID"
            .Column1.Width = 30
            .Column1.Visible = .T.
            .Column1.ReadOnly = .T.

            .Column2.Header1.Caption = "Nombre"
            .Column2.Width = 70
            .Column2.Visible = .T.
            .Column2.ReadOnly = .T.

            .Column3.Header1.Caption = "Grupo"
            .Column3.Width = 80
            .Column3.Visible = .T.
            .Column3.ReadOnly = .T.

            .Column4.Header1.Caption = "Dependencia"
            .Column5.Width = 90
            .Column4.Visible = .T.
            .Column4.ReadOnly = .T.

            .Column5.Header1.Caption = "Descripción"
            .Column5.Width = 120
            .Column5.Visible = .T.
            .Column5.ReadOnly = .T.
            
            
        ENDWITH
    ENDPROC
    
    
	*!*	 -----------------------------------------------------------------------
	*!*	 funciones


	*!*	 bindeo de eventos
	HIDDEN PROCEDURE BindeoEventos()
		*!*	 actualizar
		BindEvent(This.btnGuardar, "Click", This, "Guardar", 0)
		BindEvent(This.btnActualizar, "Click", This, "Actualizar", 0)
		BindEvent(This.btnEliminar, "Click", This, "Eliminar", 0)
        BindEvent(This.btnLeer, "Click", This, "LeerTarea", 0)


	ENDPROC

    PROCEDURE ListarTareas
        * Obtener la colección de tareas del controlador
        LOCAL oControlador, i, oTarea
        oControlador = CREATEOBJECT("Controlador")
        oControlador.This.CrearColeccionTareas()
            
        * Crear un cursor temporal para enlazar con el grid
        CREATE CURSOR curTareas (IDTarea I, Nombre C(50), Grupo C(50), Dependencia C(50), Descripcion C(100))
            
        * Recorrer la colección de tareas y agregarlas al cursor
        FOR i = 1 TO oControlador.ColeccionTareas.Count
            oTarea = oControlador.ColeccionTareas.Item(i)
            INSERT INTO curTareas (IDTarea, Nombre, Grupo, Dependencia, Descripcion) ;
                VALUES (oTarea.IDTarea, oTarea.Nombre, oTarea.Grupo, oTarea.Dependencia, oTarea.Descripcion)
        NEXT
    ENDPROC

    * Llenar los comboboxes de Grupo y Dependencia
    PROCEDURE LlenarCombos
		LOCAL i
		* Grupo
		FOR i = 1 TO This.Controlador.Grupos.ColectionGrupos.Count
			This.cbxGrupo.AddItem(This.Controlador.Grupos.ColectionGrupos.Item(i))
		NEXT
		* poner el primer item por defecto en el combo box
		This.cbxGrupo.Value = This.Controlador.Grupos.ColectionGrupos.Item(1)


		* Dependencia
		FOR i = 1 TO This.Controlador.Dependencias.ColectionDependencias.Count
			This.cbxDependencia.AddItem(This.Controlador.Dependencias.ColectionDependencias.Item(i))
		NEXT
		This.cbxDependencia.value = This.Controlador.Dependencias.ColectionDependencias.Item(1)
    ENDPROC

    PROCEDURE LlenarCampos(sIDTarea)
        LOCAL oTarea
    
        * Llamar a la función LeerTarea para obtener la tarea
        oTarea = This.LeerTarea(sIDTarea)
    
        * Verificar si se encontró la tarea
        IF NOT ISNULL(oTarea)
            Thisform.txtNombre.Value = oTarea.Nombre
            Thisform.txtGrupo.Value = oTarea.Grupo
            Thisform.txtDependencia.Value = oTarea.Dependencia
            Thisform.txtDescripcion.Value = oTarea.Descripcion
            RETURN .T.  && Llenado exitoso
        ELSE
            RETURN .F.  && No se encontró la tarea
        ENDIF
    ENDPROC
    
    PROCEDURE LeerTarea(sIDTarea)
        LOCAL i, oTarea, sIDTareaStr
    
        * Verificar si sIDTarea es un número y convertirlo a cadena si es necesario
        DO CASE
            CASE VARTYPE(sIDTarea) == "I"
                sIDTareaStr = ALLTRIM(STR(sIDTarea))
            CASE VARTYPE(sIDTarea) == "N"
                sIDTareaStr = ALLTRIM(STR(sIDTarea))
            CASE VARTYPE(sIDTarea) == "C"
                sIDTareaStr = ALLTRIM(sIDTarea)
            OTHERWISE
                RETURN .NULL.  && Si sIDTarea no es ni número ni cadena, retornar NULL
        ENDCASE
    
        * Recorrer la colección de tareas
        FOR i = 1 TO This.ColeccionTareas.Count
            oTarea = This.ColeccionTareas.Item(i)
            IF ALLTRIM(STR(oTarea.IDTarea)) = sIDTareaStr
                RETURN oTarea
            ENDIF
        NEXT
    
        RETURN .NULL.  && Si no se encuentra la tarea
    ENDPROC

    * Guardar una nueva tarea
    PROCEDURE Guardar
        *!*	 IF This.LimpiarCampos() THEN 
        *!*	     MESSAGEBOX("No se puede Guardar, no hay Datos", 0, "Aviso")
        *!*	 ELSE
        *!*	     * Lógica para actualizar la tarea
        *!*	     MESSAGEBOX("Se Guardo exitosamente", 0, "Aviso")
        *!*	 ENDIF

        LOCAL sNombre, sGrupo, sDependencia, sDescripcion
        sNombre = Thisform.txtNombre.Value
        sGrupo = Thisform.cbxGrupo.Value
        sDependencia = Thisform.cbxDependencia.Value
        sDescripcion = Thisform.txtDescripcion.Value
        This.Controlador.AgregarTarea(sNombre, sGrupo, sDependencia, sDescripcion)
        This.ListarTareas()
        This.LimpiarCampos()

    ENDPROC
    

	* Actualizar una tarea existente
    PROCEDURE Actualizar
		IF This.LimpiarCampos() THEN 
			MESSAGEBOX("No se puede Actualizar", 0, "Aviso")
		ELSE
			* Lógica para actualizar la tarea
			MESSAGEBOX("Actualización exitosa", 0, "Aviso")
		ENDIF
    ENDPROC

	* Eliminar una tarea por su ID
    PROCEDURE Eliminar
		*!*	 IF This.LimpiarCampos() THEN 
		*!*	 	MESSAGEBOX("No se puede Eliminar", 0, "Aviso")
		*!*	 ELSE
		*!*	 	* Lógica para actualizar la tarea
		*!*	 	MESSAGEBOX("Eliminacion exitosa", 0, "Aviso")
		*!*	 ENDIF

        LOCAL sIDTarea
        sIDTarea = Thisform.txtID.Value
        IF EMPTY(sIDTarea)
            MESSAGEBOX("Ingrese un ID de tarea para eliminar.", 16, "Error")
            RETURN
        ENDIF
        IF !Thisform.txtID.Value = ALLTRIM(STR(Thisform.txtID.Value))
            MESSAGEBOX("El ID de tarea debe ser un número entero.", 16, "Error")
            RETURN
        ENDIF
        This.Controlador.EliminarTarea(Thisform.txtID.Value)
        This.ListarTareas()
        This.LimpiarCampos()
    ENDPROC

	* Limpiar los campos del formulario
    PROCEDURE LimpiarCampos
        WITH Thisform
            * .txtID.Value = ""
            .txtNombre.Value = ""
            *!*	 .cbxGrupo.Value = ""
            *!*	 .cbxDependencia.Value = ""
            .txtDescripcion.Value = ""
			This.LlenarCombos()
        ENDWITH
    ENDPROC


	PROCEDURE Err_Handler(oError)
		LOCAL lcErrorMsg
		lcErrorMsg = "Error #" + TRANSFORM(oError.ErrorNo) + CHR(13) + ;
					"Message: " + oError.Message + CHR(13) + ;
					"Line: " + TRANSFORM(oError.LineNo) + CHR(13) + ;
					"Details: " + oError.Details + CHR(13) + ;
					"Program: " + oError.Program + CHR(13) + ;
					"Method: " + oError.Method
	
		MESSAGEBOX(lcErrorMsg, 16, "Error")
	ENDPROC
		
ENDDEFINE
